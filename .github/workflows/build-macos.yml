name: Build and Release (macOS Universal)

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # æ„å»ºä¸åŒæ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶
  build:
    name: Build ${{ matrix.target }}
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            arch: arm64
            name: Apple Silicon
          - target: x86_64-apple-darwin
            arch: x64
            name: Intel

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # å®‰è£… Rust å·¥å…·é“¾å’Œç›®æ ‡æ¶æ„
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      # ç¼“å­˜ Rust æ„å»ºäº§ç‰©
      - name: Cache Rust cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Rust cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Rust cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      # å®‰è£… Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # å®‰è£… pnpm
      - name: Install pnpm
        run: npm install -g pnpm

      # ç¼“å­˜ Node.js ä¾èµ–
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            src-tauri/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # å®‰è£…ä¾èµ–
      - name: Install frontend dependencies
        run: pnpm install

      # æ„å»ºå‰ç«¯
      - name: Build frontend
        run: pnpm build

      # æ„å»º Rust äºŒè¿›åˆ¶æ–‡ä»¶
      - name: Build Rust binary for ${{ matrix.name }}
        run: |
          cd src-tauri
          cargo build --release --target ${{ matrix.target }}

      # æ‰“åŒ… .app bundle
      - name: Create .app bundle for ${{ matrix.name }}
        run: |
          cd src-tauri

          # å¤åˆ¶ arm64 ç‰ˆæœ¬çš„ .app ç»“æ„ä½œä¸ºæ¨¡æ¿
          if [ "${{ matrix.target }}" == "aarch64-apple-darwin" ]; then
            pnpm tauri build --target ${{ matrix.target }}
          else
            # å¯¹äº x86_64ï¼Œæ‰‹åŠ¨æ„å»º .app
            mkdir -p target/${{ matrix.target }}/release/bundle/macos

            # ä½¿ç”¨ tauri CLI æ„å»ºï¼ˆä½†ä¸ç­¾åï¼‰
            cargo tauri build --target ${{ matrix.target }} || true

            # å¦‚æœ CLI å¤±è´¥ï¼Œæ‰‹åŠ¨åˆ›å»º .app
            if [ ! -d "target/${{ matrix.target }}/release/bundle/macos/etools.app" ]; then
              APP_BUNDLE="target/${{ matrix.target }}/release/bundle/macos/etools.app"
              mkdir -p "$APP_BUNDLE/Contents"/{MacOS,Resources}

              # å¤åˆ¶ Info.plist
              cp target/aarch64-apple-darwin/release/bundle/macos/etools.app/Contents/Info.plist \
                 "$APP_BUNDLE/Contents/Info.plist" 2>/dev/null || true

              # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
              cp target/${{ matrix.target }}/release/etools "$APP_BUNDLE/Contents/MacOS/"

              # å¤åˆ¶èµ„æºæ–‡ä»¶
              cp -r target/aarch64-apple-darwin/release/bundle/macos/etools.app/Contents/Resources/* \
                    "$APP_BUNDLE/Contents/Resources/" 2>/dev/null || true
            fi
          fi

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload architecture artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.arch }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/etools
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app

  # åˆ›å»º Universal Binary
  create_universal:
    name: Create Universal Binary
    needs: build
    runs-on: macos-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # ä¸‹è½½æ‰€æœ‰æ¶æ„çš„æ„å»ºäº§ç‰©
      - name: Download all architecture artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # åˆ›å»º Universal Binary
      - name: Create Universal Binary
        run: |
          echo "ğŸğŸ”§ åˆ›å»º Universal Binary (Apple Silicon + Intel)..."

          # è®¾ç½®å˜é‡
          ARM64_BINARY="artifacts/app-arm64/aarch64-apple-darwin/release/etools"
          X64_BINARY="artifacts/app-x64/x86_64-apple-darwin/release/etools"
          UNIVERSAL_BINARY="src-tauri/target/universal/release/etools"

          # åˆ›å»ºç›®å½•
          mkdir -p "$(dirname "$UNIVERSAL_BINARY")"

          # ä½¿ç”¨ lipo åˆå¹¶äºŒè¿›åˆ¶æ–‡ä»¶
          lipo -create \
            "$ARM64_BINARY" \
            "$X64_BINARY" \
            -output "$UNIVERSAL_BINARY"

          # éªŒè¯ Universal Binary
          echo "âœ… Universal Binary æ¶æ„ä¿¡æ¯:"
          lipo -info "$UNIVERSAL_BINARY"

          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          ls -lh "$UNIVERSAL_BINARY"

      # åˆ›å»º Universal .app bundle
      - name: Create Universal .app bundle
        run: |
          echo "ğŸ“¦ åˆ›å»º Universal .app bundle..."

          ARM64_APP="artifacts/app-arm64/aarch64-apple-darwin/release/bundle/macos/etools.app"
          UNIVERSAL_APP="src-tauri/target/universal/release/bundle/macos/etools.app"
          UNIVERSAL_BINARY="src-tauri/target/universal/release/etools"

          # åˆ›å»ºç›®å½•
          mkdir -p "$(dirname "$UNIVERSAL_APP")"

          # å¤åˆ¶ arm64 .app ç»“æ„
          cp -R "$ARM64_APP" "$UNIVERSAL_APP"

          # æ›¿æ¢äºŒè¿›åˆ¶æ–‡ä»¶ä¸º Universal Binary
          cp "$UNIVERSAL_BINARY" "$UNIVERSAL_APP/Contents/MacOS/etools"

          # é‡æ–°ç­¾å
          codesign --force --deep --sign - "$UNIVERSAL_APP" 2>/dev/null || true

          # æ˜¾ç¤º .app å¤§å°
          du -sh "$UNIVERSAL_APP"

      # åˆ›å»º Universal DMG
      - name: Create Universal DMG
        run: |
          echo "ğŸ’¿ åˆ›å»º Universal DMG..."

          UNIVERSAL_APP="src-tauri/target/universal/release/bundle/macos/etools.app"
          DMG_DIR="src-tauri/target/universal/release/bundle/dmg"
          mkdir -p "$DMG_DIR"

          # è·å–ç‰ˆæœ¬å·
          VERSION=$(node -p "require('./package.json').version")

          # åˆ›å»º DMG
          hdiutil create \
            -volname "etools" \
            -srcfolder "$UNIVERSAL_APP" \
            -ov \
            -format UDZO \
            "$DMG_DIR/etools_${VERSION}_universal.dmg"

          # æ˜¾ç¤º DMG ä¿¡æ¯
          ls -lh "$DMG_DIR/"*.dmg

      # ä¸Šä¼  Universal æ„å»ºäº§ç‰©
      - name: Upload universal artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: |
            src-tauri/target/universal/release/bundle/macos/*.app
            src-tauri/target/universal/release/bundle/dmg/*.dmg

      # åˆ›å»º GitHub Release
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/universal/release/bundle/dmg/*.dmg
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## ğŸ‰ Universal Binary Release

            æ­¤ç‰ˆæœ¬åŒ…å« **Universal Binary**ï¼ŒåŒæ—¶æ”¯æŒï¼š
            - ğŸ Apple Silicon (M1/M2/M3)
            - ğŸ”§ Intel (x86_64)

            ### ä¸‹è½½å®‰è£…
            ä¸‹è½½ `.dmg` æ–‡ä»¶å¹¶åŒå‡»å®‰è£…å³å¯ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ„å»ºçŠ¶æ€æ£€æŸ¥ï¼ˆä»…å¯¹ PR å’Œæ™®é€š pushï¼‰
      - name: Build summary
        if: "!startsWith(github.ref, 'refs/tags/v')"
        run: |
          echo "âœ… Universal Binary æ„å»ºå®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
          ls -lh src-tauri/target/universal/release/bundle/dmg/
          ls -lh src-tauri/target/universal/release/bundle/macos/
          echo ""
          echo "ğŸ—ï¸ Universal Binary æ¶æ„:"
          lipo -info src-tauri/target/universal/release/etools
